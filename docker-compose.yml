# Local development docker-compose for Reactorcide
# Usage: docker compose up -d

services:
    # PostgreSQL database for Coordinator
    postgres:
        image: postgres:17
        container_name: reactorcide-postgres-dev
        environment:
            POSTGRES_USER: reactorcide
            POSTGRES_PASSWORD: devpass123
            POSTGRES_DB: reactorcide_db
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U reactorcide"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - reactorcide

    # PostgreSQL database for Corndogs
    postgres-corndogs:
        image: postgres:17
        container_name: reactorcide-postgres-corndogs-dev
        environment:
            POSTGRES_USER: reactorcide
            POSTGRES_PASSWORD: devpass123
            POSTGRES_DB: corndogs_db
        ports:
            - "5433:5432"
        volumes:
            - postgres_corndogs_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U reactorcide"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - reactorcide

    # Corndogs Task Queue
    corndogs:
        image: quay.io/catalystcommunity/corndogs:latest
        container_name: reactorcide-corndogs-dev
        environment:
            DATABASE_HOST: postgres-corndogs
            DATABASE_PORT: "5432"
            DATABASE_NAME: corndogs_db
            DATABASE_USER: reactorcide
            DATABASE_PASSWORD: devpass123
            DATABASE_SSL_MODE: disable
            GRPC_PORT: 5080
            GRPC_BIND_ADDRESS: 0.0.0.0
        ports:
            - "5080:5080"
        depends_on:
            postgres-corndogs:
                condition: service_healthy
        networks:
            - reactorcide
        command: ["run"]

    # Coordinator API
    coordinator-api:
        build:
            context: .
            dockerfile: Dockerfile.coordinator.dev
        image: reactorcide/coordinator:dev
        container_name: reactorcide-coordinator-dev
        command: ["serve"]
        environment:
            REACTORCIDE_DB_URI: "postgresql://reactorcide:devpass123@postgres:5432/reactorcide_db?sslmode=disable"
            PORT: "8080"
            REACTORCIDE_CORNDOGS_BASE_URL: corndogs:5080
            REACTORCIDE_JWT_SECRET: dev-secret-change-in-production-12345
            REACTORCIDE_OBJECT_STORE_TYPE: filesystem
            REACTORCIDE_OBJECT_STORE_BASE_PATH: /var/lib/reactorcide
            REACTORCIDE_LOG_LEVEL: debug
            REACTORCIDE_DEFAULT_USER_ID: "550e8400-e29b-41d4-a716-446655440000"
        ports:
            - "8080:8080"
        volumes:
            - reactorcide_data:/var/lib/reactorcide
        depends_on:
            postgres:
                condition: service_healthy
            corndogs:
                condition: service_started
        networks:
            - reactorcide

    # Worker
    worker:
        build:
            context: .
            dockerfile: Dockerfile.worker.dev
        image: reactorcide/worker:dev
        container_name: reactorcide-worker-dev
        environment:
            REACTORCIDE_DB_URI: "postgresql://reactorcide:devpass123@postgres:5432/reactorcide_db?sslmode=disable"
            REACTORCIDE_CORNDOGS_BASE_URL: corndogs:5080
            REACTORCIDE_WORKER_QUEUE: reactorcide-jobs
            REACTORCIDE_WORKER_CONCURRENCY: "2"
            REACTORCIDE_WORKER_POLL_INTERVAL: "5"
            REACTORCIDE_CONTAINER_RUNTIME: docker
            REACTORCIDE_OBJECT_STORE_TYPE: filesystem
            REACTORCIDE_OBJECT_STORE_BASE_PATH: /var/lib/reactorcide
            REACTORCIDE_LOG_LEVEL: debug
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - reactorcide_data:/var/lib/reactorcide
            - /tmp/reactorcide-jobs:/tmp/reactorcide-jobs
        depends_on:
            coordinator-api:
                condition: service_started
            corndogs:
                condition: service_started
        networks:
            - reactorcide

networks:
    reactorcide:
        driver: bridge

volumes:
    postgres_data:
    postgres_corndogs_data:
    reactorcide_data:
