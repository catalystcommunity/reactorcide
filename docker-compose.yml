services:
    # PostgreSQL database for Coordinator
    postgres:
        image: postgres:17
        container_name: reactorcide-postgres-dev
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - reactorcide

    # PostgreSQL database for Corndogs
    postgres-corndogs:
        image: postgres:17
        container_name: reactorcide-postgres-corndogs-dev
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${CORNDOGS_DB_NAME}
        ports:
            - "5433:5432"
        volumes:
            - postgres_corndogs_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - reactorcide

    # Corndogs Task Queue
    corndogs:
        image: reactorcide/corndogs:latest
        container_name: reactorcide-corndogs-dev
        environment:
            DATABASE_HOST: postgres-corndogs
            DATABASE_PORT: "5432"
            DATABASE_NAME: ${CORNDOGS_DB_NAME}
            DATABASE_USER: ${POSTGRES_USER}
            DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
            DATABASE_SSL_MODE: disable
            GRPC_PORT: 5080
            GRPC_BIND_ADDRESS: 0.0.0.0
        ports:
            - "5080:5080"
        depends_on:
            postgres-corndogs:
                condition: service_healthy
        networks:
            - reactorcide

    # Coordinator API
    coordinator-api:
        build:
            context: .
            dockerfile: Dockerfile.coordinator.dev
        image: reactorcide/coordinator:dev
        container_name: reactorcide-coordinator-dev
        command: ["serve"]
        environment:
            DB_URI: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable"
            PORT: "8080"
            CORNDOGS_BASE_URL: ${REACTORCIDE_CORNDOGS_ENDPOINT}
            REACTORCIDE_JWT_SECRET: ${REACTORCIDE_JWT_SECRET}
            OBJECT_STORE_TYPE: ${REACTORCIDE_OBJECT_STORE_TYPE}
            OBJECT_STORE_BASE_PATH: ${REACTORCIDE_OBJECT_STORE_BASE_PATH}
            REACTORCIDE_LOG_LEVEL: ${REACTORCIDE_LOG_LEVEL}
            REACTORCIDE_CI_CODE_ALLOWLIST: ${REACTORCIDE_CI_CODE_ALLOWLIST}
            REACTORCIDE_DEFAULT_CI_SOURCE_URL: ${REACTORCIDE_DEFAULT_CI_SOURCE_URL}
            REACTORCIDE_DEFAULT_CI_SOURCE_REF: ${REACTORCIDE_DEFAULT_CI_SOURCE_REF}
        ports:
            - "8080:8080"
        volumes:
            - reactorcide_data:${REACTORCIDE_OBJECT_STORE_BASE_PATH}
        depends_on:
            postgres:
                condition: service_healthy
            corndogs:
                condition: service_started
        networks:
            - reactorcide

    # Worker
    worker:
        build:
            context: .
            dockerfile: Dockerfile.worker.dev
        image: reactorcide/worker:dev
        container_name: reactorcide-worker-dev
        environment:
            DB_URI: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable"
            CORNDOGS_BASE_URL: ${REACTORCIDE_CORNDOGS_ENDPOINT}
            WORKER_QUEUE: ${REACTORCIDE_CORNDOGS_QUEUE}
            WORKER_CONCURRENCY: ${REACTORCIDE_WORKER_CONCURRENCY}
            WORKER_POLL_INTERVAL: ${REACTORCIDE_WORKER_POLL_INTERVAL}
            REACTORCIDE_CONTAINER_RUNTIME: ${REACTORCIDE_CONTAINER_RUNTIME}
            OBJECT_STORE_TYPE: ${REACTORCIDE_OBJECT_STORE_TYPE}
            OBJECT_STORE_BASE_PATH: ${REACTORCIDE_OBJECT_STORE_BASE_PATH}
            REACTORCIDE_LOG_LEVEL: ${REACTORCIDE_LOG_LEVEL}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - reactorcide_data:${REACTORCIDE_OBJECT_STORE_BASE_PATH}
            - /tmp/reactorcide-jobs:/tmp/reactorcide-jobs
        depends_on:
            coordinator-api:
                condition: service_started
            corndogs:
                condition: service_started
        networks:
            - reactorcide

networks:
    reactorcide:
        driver: bridge

volumes:
    postgres_data:
    postgres_corndogs_data:
    reactorcide_data:
