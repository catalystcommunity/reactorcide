apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.name" . }}-config
  labels:
    {{- include "app.labels" . | nindent 4 }}
data:
  # Core configuration
  GRPC_MAX_MSG_SIZE_BYTES: {{ .Values.grpc.maxMessageSizeBytes | quote }}
  PORT: {{ .Values.app.service.port | quote }}
  COMMIT_ON_SUCCESS: {{ .Values.app.commitOnSuccess | quote }}

  # Prometheus configuration
  PROMETHEUS_ENABLED: {{ .Values.app.prometheus.enabled | quote }}
  PROMETHEUS_PATH: {{ .Values.app.prometheus.path | quote }}
  PROMETHEUS_PORT: {{ .Values.app.prometheus.port | quote }}
  PROMETHEUS_LATENCY_HISTOGRAMS_ENABLED: {{ .Values.app.prometheus.latencyHistogramsEnabled | quote }}

  # Corndogs configuration (gRPC - no http:// prefix)
  {{- if .Values.corndogs.enabled }}
  # Corndogs subchart is deployed - use internal service
  REACTORCIDE_CORNDOGS_BASE_URL: "{{ .Release.Name }}-corndogs:{{ .Values.corndogs.service.port }}"
  {{- else if .Values.corndogs.baseUrl }}
  # External Corndogs provided
  REACTORCIDE_CORNDOGS_BASE_URL: {{ .Values.corndogs.baseUrl | quote }}
  {{- end }}

  # Default configuration
  DEFAULT_QUEUE_NAME: {{ .Values.defaults.queueName | quote }}
  DEFAULT_TIMEOUT: {{ .Values.defaults.timeout | quote }}
  {{- if .Values.defaults.runnerImage }}
  REACTORCIDE_DEFAULT_RUNNER_IMAGE: {{ .Values.defaults.runnerImage | quote }}
  {{- end }}
  # REACTORCIDE_DEFAULT_USER_ID is read from {{ .Values.defaults.userSecretName }} secret

  # Object store configuration
  REACTORCIDE_OBJECT_STORE_TYPE: {{ .Values.objectStore.type | quote }}
  REACTORCIDE_OBJECT_STORE_BUCKET: {{ .Values.objectStore.bucket | quote }}
  REACTORCIDE_OBJECT_STORE_BASE_PATH: {{ .Values.objectStore.basePath | quote }}
  REACTORCIDE_OBJECT_STORE_PREFIX: {{ .Values.objectStore.prefix | quote }}
  {{- if eq .Values.objectStore.type "s3" }}
  AWS_REGION: {{ .Values.objectStore.s3.region | quote }}
  REACTORCIDE_S3_ENDPOINT: {{ .Values.objectStore.s3.endpoint | quote }}
  {{- end }}

  # Worker configuration
  WORKER_QUEUE: {{ .Values.worker.queue | quote }}
  WORKER_POLL_INTERVAL: {{ .Values.worker.pollInterval | quote }}
  WORKER_CONCURRENCY: {{ .Values.worker.concurrency | quote }}
  WORKER_DRY_RUN: {{ .Values.worker.dryRun | quote }}

  # API URL for job containers to submit triggers (reachable from job pods)
  REACTORCIDE_JOB_API_URL: "http://{{ include "app.name" . }}-api:{{ .Values.app.service.port }}"