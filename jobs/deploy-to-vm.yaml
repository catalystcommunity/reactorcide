name: deploy-reactorcide-vm
image: containers.catalystsquad.com/public/reactorcide/runnerbase:dev
command: |-
    set -euo pipefail

    echo "========================================"
    echo "Reactorcide VM Deployment"
    echo "========================================"
    echo "Target: ${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}"
    echo "Domains: ${REACTORCIDE_DEPLOY_DOMAINS}"
    echo ""

    # Setup SSH from environment variable
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    if [ -z "${SSH_PRIVATE_KEY:-}" ]; then
      echo "ERROR: SSH_PRIVATE_KEY environment variable not set"
      exit 1
    fi

    echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    echo "SSH key configured"

    # Add host to known_hosts to avoid prompt
    ssh-keyscan -H "${REACTORCIDE_DEPLOY_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true

    # Test SSH connection
    echo "Testing SSH connection..."
    if ! ssh -o ConnectTimeout=10 "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" "echo SSH OK"; then
      echo "ERROR: SSH connection failed"
      exit 1
    fi

    # Generate secrets if not provided
    DB_PASSWORD="${REACTORCIDE_DB_PASSWORD:-$(openssl rand -hex 24)}"
    JWT_SECRET="${REACTORCIDE_JWT_SECRET:-$(openssl rand -hex 32)}"
    REMOTE_DIR="${REACTORCIDE_REMOTE_DIR:-~/reactorcide}"

    echo ""
    echo "Step 1: Creating remote directory structure"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" "mkdir -p ${REMOTE_DIR}"

    echo ""
    echo "Step 2: Copying deployment files"
    rsync -avz --progress \
      /job/deployment/ \
      "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}:${REMOTE_DIR}/"

    echo ""
    echo "Step 3: Checking environment configuration on VM"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" bash -s <<'REMOTE_EOF'
    set -euo pipefail
    cd ~/reactorcide

    if [ -f .env ]; then
      echo "Existing .env found - preserving configuration"
      echo "Current config (passwords masked):"
      grep -v PASSWORD .env | grep -v SECRET | grep -v URI || true
    else
      echo "No existing .env found - creating new configuration"
      DB_PASSWORD=$(openssl rand -hex 24)
      JWT_SECRET=$(openssl rand -hex 32)

      cat > .env <<ENVFILE
    # Database Configuration (for postgres containers)
    POSTGRES_USER=reactorcide
    POSTGRES_PASSWORD=${DB_PASSWORD}
    POSTGRES_DB=reactorcide_db
    CORNDOGS_DB_NAME=corndogs_db

    # Reactorcide Configuration
    REACTORCIDE_DB_URI=postgresql://reactorcide:${DB_PASSWORD}@postgres:5432/reactorcide_db?sslmode=disable
    REACTORCIDE_JWT_SECRET=${JWT_SECRET}

    # Object Storage Configuration
    # WARNING: Job logs are stored here. The 'filesystem' type stores logs in a Docker volume.
    # If you remove the reactorcide_data volume, all job logs will be lost.
    # For production deployments, consider using S3/GCS object storage instead.
    # Options: filesystem, s3, gcs
    REACTORCIDE_OBJECT_STORE_TYPE=filesystem
    REACTORCIDE_OBJECT_STORE_BASE_PATH=/data/reactorcide

    # Worker Configuration
    REACTORCIDE_WORKER_CONCURRENCY=2
    REACTORCIDE_WORKER_POLL_INTERVAL=5
    REACTORCIDE_CONTAINER_RUNTIME=docker
    REACTORCIDE_LOG_LEVEL=info
    ENVFILE

      # Remove leading whitespace from .env file
      sed -i 's/^    //' .env

      echo "Environment configuration created"
    fi
    REMOTE_EOF

    echo ""
    echo "Step 4: Pulling Docker images on VM"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" bash -s <<'REMOTE_EOF'
    set -euo pipefail
    cd ~/reactorcide

    # Pull all Reactorcide images from registry
    echo "Pulling coordinator image..."
    docker compose -f docker-compose.prod.yml pull coordinator-api

    echo "Pulling worker image..."
    docker compose -f docker-compose.prod.yml pull worker

    # Pull runner image (used by worker to spawn job containers)
    RUNNER_IMAGE="containers.catalystsquad.com/public/reactorcide/runnerbase:dev"
    echo "Pulling runner image: ${RUNNER_IMAGE}..."
    docker pull "${RUNNER_IMAGE}"

    # Tag as local name for worker to use
    docker tag "${RUNNER_IMAGE}" reactorcide/runner:latest

    echo "Images ready"
    REMOTE_EOF

    echo ""
    echo "Step 5: Starting services"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" bash -s <<'REMOTE_EOF'
    set -euo pipefail
    cd ~/reactorcide

    # Stop existing services
    echo "Stopping existing services..."
    docker compose -f docker-compose.prod.yml down || true

    # Start services
    echo "Starting services..."
    docker compose -f docker-compose.prod.yml up -d

    # Wait for startup
    sleep 10

    # Show status
    docker compose -f docker-compose.prod.yml ps
    REMOTE_EOF

    echo ""
    echo "Step 6: Waiting for postgres to be healthy"
    for i in $(seq 1 30); do
      if ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" "docker exec reactorcide-postgres pg_isready -U reactorcide" > /dev/null 2>&1; then
        echo "Postgres is ready"
        break
      fi
      echo "Waiting for postgres... ($i/30)"
      sleep 2
    done

    echo ""
    echo "Step 7: Running database migrations"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" "docker exec reactorcide-coordinator /reactorcide migrate"

    echo ""
    echo "Step 8: Restarting coordinator to pick up migrations"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" bash -s <<'REMOTE_EOF'
    set -euo pipefail
    cd ~/reactorcide
    docker compose -f docker-compose.prod.yml restart coordinator-api
    REMOTE_EOF

    echo ""
    echo "Step 9: Waiting for coordinator to be healthy"
    for i in $(seq 1 30); do
      if ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" "curl -sf http://localhost:6080/api/v1/health" > /dev/null 2>&1; then
        echo "Coordinator is healthy"
        break
      fi
      echo "Waiting... ($i/30)"
      sleep 2
    done

    echo ""
    echo "Step 10: Verifying database and users"
    USER_COUNT=$(ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" \
      "docker exec reactorcide-postgres psql -U reactorcide -d reactorcide_db -t -c 'SELECT COUNT(*) FROM users;'" | tr -d ' ')
    if [ "$USER_COUNT" -gt 0 ]; then
      echo "Users exist in database (found $USER_COUNT user(s))"
    else
      echo "ERROR: No users found in database"
      exit 1
    fi

    echo ""
    echo "Step 11: Final verification"
    ssh "${REACTORCIDE_DEPLOY_USER}@${REACTORCIDE_DEPLOY_HOST}" bash -s <<'REMOTE_EOF'
    set -euo pipefail
    cd ~/reactorcide

    if curl -sf http://localhost:6080/api/v1/health > /dev/null; then
      echo "Coordinator API is healthy"
    else
      echo "API health check failed"
      exit 1
    fi

    # Show running services
    echo ""
    echo "Running services:"
    docker compose -f docker-compose.prod.yml ps --format "table {{.Name}}\t{{.Status}}"
    REMOTE_EOF

    echo ""
    echo "========================================"
    echo "Deployment completed successfully!"
    echo "========================================"
    echo ""
    echo "Access the API: http://${REACTORCIDE_DEPLOY_HOST}:6080/api/v1/health"
environment:
    # Required - target configuration
    REACTORCIDE_DEPLOY_HOST: "${env:REACTORCIDE_DEPLOY_HOST}"
    REACTORCIDE_DEPLOY_USER: "${env:REACTORCIDE_DEPLOY_USER}"
    REACTORCIDE_DEPLOY_DOMAINS: "${env:REACTORCIDE_DEPLOY_DOMAINS}"

    # Required - SSH key for deployment (secret)
    SSH_PRIVATE_KEY: "${secret:reactorcide/deploy:ssh_private_key}"

    # Optional - can use secrets or generate at runtime
    REACTORCIDE_DB_PASSWORD: "${secret:reactorcide/deploy:db_password}"
    REACTORCIDE_JWT_SECRET: "${secret:reactorcide/deploy:jwt_secret}"

    # Optional with defaults
    REACTORCIDE_WORKER_CONCURRENCY: "${env:REACTORCIDE_WORKER_CONCURRENCY}"
    REACTORCIDE_WORKER_POLL_INTERVAL: "${env:REACTORCIDE_WORKER_POLL_INTERVAL}"
    REACTORCIDE_LOG_LEVEL: "${env:REACTORCIDE_LOG_LEVEL}"
    REACTORCIDE_RUNNER_IMAGE: "${env:REACTORCIDE_RUNNER_IMAGE}"
    REACTORCIDE_REMOTE_DIR: "${env:REACTORCIDE_REMOTE_DIR}"
