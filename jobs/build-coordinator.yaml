name: build-coordinator
image: golang:1.23-alpine
capabilities:
  - docker
command: |-
  sh -c '
    set -euo pipefail

    echo "Building coordinator image: $REGISTRY/$IMAGE:$TAG"

    # Install nerdctl (containerd CLI) and git
    apk add --no-cache git
    NERDCTL_VERSION=2.1.3
    wget -q "https://github.com/containerd/nerdctl/releases/download/v${NERDCTL_VERSION}/nerdctl-${NERDCTL_VERSION}-linux-amd64.tar.gz" -O /tmp/nerdctl.tar.gz
    tar -xzf /tmp/nerdctl.tar.gz -C /usr/local/bin nerdctl
    rm /tmp/nerdctl.tar.gz

    # Build the Go binary
    echo "Building reactorcide binary..."
    cd /job/coordinator_api
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o reactorcide .

    # Copy binary to deployment directory
    cp reactorcide /job/deployment/

    # Build container image
    echo "Building container image..."
    cd /job/deployment
    nerdctl build -t "$REGISTRY/$IMAGE:$TAG" -f Dockerfile.coordinator .

    # Login and push
    echo "$REGISTRY_PASSWORD" | nerdctl login "$REGISTRY" -u "$REGISTRY_USER" --password-stdin
    nerdctl push "$REGISTRY/$IMAGE:$TAG"

    # Cleanup
    rm -f /job/deployment/reactorcide

    echo "Done! Image pushed to $REGISTRY/$IMAGE:$TAG"
  '
environment:
  REGISTRY: containers.catalystsquad.com
  IMAGE: public/reactorcide/coordinator
  TAG: dev
  REGISTRY_USER: "${env:REGISTRY_USER}"
  REGISTRY_PASSWORD: "${secret:reactorcide/local-dev:registry_password}"
